<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Speech SDK Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #764ba2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Azure Speech SDK Test</h1>
        
        <div class="test-section">
            <h2>Step 1: Configuration Check</h2>
            <div id="config-status">Checking configuration...</div>
            <div id="config-details" class="info" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>Step 2: SDK Availability</h2>
            <div id="sdk-status">Checking SDK...</div>
        </div>

        <div class="test-section">
            <h2>Step 3: Test Pronunciation Assessment</h2>
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Click "Start Recording"</li>
                <li>Wait for the prompt</li>
                <li>Say "‰Ω†Â•Ω" (n«ê h«éo - Hello) clearly</li>
                <li>The recording will automatically stop after you speak</li>
            </ol>
            <button id="test-btn" onclick="testPronunciation()">üé§ Start Recording</button>
            <button id="stop-btn" onclick="stopRecording()" style="display:none; background:#dc3545;">‚èπÔ∏è Stop Recording</button>
            <div id="test-status" style="margin-top: 10px;"></div>
            <div id="test-results" style="margin-top: 10px;"></div>
        </div>

        <div class="test-section">
            <h2>Summary</h2>
            <div id="summary"></div>
        </div>
    </div>

    <!-- Azure Speech SDK -->
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    
    <script type="module">
        import { azureSpeechConfig, pronunciationAssessmentConfig } from './js/config.js';

        let speechConfig = null;
        let recognizer = null;

        // Step 1: Check Configuration
        function checkConfiguration() {
            const statusDiv = document.getElementById('config-status');
            const detailsDiv = document.getElementById('config-details');
            
            let issues = [];
            let warnings = [];
            
            // Check subscription key
            if (!azureSpeechConfig.subscriptionKey || azureSpeechConfig.subscriptionKey === 'YOUR_AZURE_SPEECH_KEY') {
                issues.push('‚ùå Subscription key not configured');
            } else {
                warnings.push('‚úÖ Subscription key configured (length: ' + azureSpeechConfig.subscriptionKey.length + ' chars)');
            }
            
            // Check region
            if (!azureSpeechConfig.serviceRegion || azureSpeechConfig.serviceRegion === 'YOUR_AZURE_REGION') {
                issues.push('‚ùå Service region not configured');
            } else {
                warnings.push('‚úÖ Service region: ' + azureSpeechConfig.serviceRegion);
            }
            
            // Check language
            if (azureSpeechConfig.language === 'zh-CN') {
                warnings.push('‚úÖ Language set to Mandarin Chinese (zh-CN)');
            }
            
            if (issues.length > 0) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = issues.join('<br>');
            } else {
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '‚úÖ Configuration looks good!';
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = warnings.join('<br>');
            }
            
            return issues.length === 0;
        }

        // Step 2: Check SDK
        function checkSDK() {
            const statusDiv = document.getElementById('sdk-status');
            
            if (typeof SpeechSDK === 'undefined') {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Azure Speech SDK not loaded. Check your internet connection.';
                return false;
            } else {
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '‚úÖ Azure Speech SDK loaded successfully!';
                return true;
            }
        }

        // Stop recording function
        window.stopRecording = function() {
            const statusDiv = document.getElementById('test-status');
            const testBtn = document.getElementById('test-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            if (recognizer) {
                statusDiv.className = 'status warning';
                statusDiv.innerHTML = '‚èπÔ∏è Stopping and processing...';
                recognizer.stopContinuousRecognitionAsync(
                    () => {
                        testBtn.disabled = false;
                        stopBtn.style.display = 'none';
                        statusDiv.className = 'status';
                        statusDiv.innerHTML = 'Recording stopped. Click "Start Recording" to try again.';
                        if (recognizer) {
                            recognizer.close();
                            recognizer = null;
                        }
                    },
                    (error) => {
                        testBtn.disabled = false;
                        stopBtn.style.display = 'none';
                        statusDiv.className = 'status error';
                        statusDiv.innerHTML = '‚ùå Error stopping: ' + error;
                        if (recognizer) {
                            recognizer.close();
                            recognizer = null;
                        }
                    }
                );
            }
        };

        // Step 3: Test Pronunciation
        window.testPronunciation = async function() {
            const statusDiv = document.getElementById('test-status');
            const resultsDiv = document.getElementById('test-results');
            const testBtn = document.getElementById('test-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            try {
                testBtn.disabled = true;
                testBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                
                statusDiv.className = 'status warning';
                statusDiv.innerHTML = 'üé§ Initializing microphone...';
                resultsDiv.innerHTML = '';
                
                // Initialize speech config
                if (!speechConfig) {
                    speechConfig = SpeechSDK.SpeechConfig.fromSubscription(
                        azureSpeechConfig.subscriptionKey,
                        azureSpeechConfig.serviceRegion
                    );
                    speechConfig.speechRecognitionLanguage = azureSpeechConfig.language;
                }
                
                // Create pronunciation assessment config
                const referenceText = '‰Ω†Â•Ω';
                const pronConfig = new SpeechSDK.PronunciationAssessmentConfig(
                    referenceText,
                    SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark,
                    SpeechSDK.PronunciationAssessmentGranularity.Phoneme,
                    true
                );
                
                // Get microphone
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                
                // Create recognizer
                recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                pronConfig.applyTo(recognizer);
                
                // Update status - recording started
                setTimeout(() => {
                    statusDiv.innerHTML = 'üé§ Recording... Speak now: "‰Ω†Â•Ω" (n«ê h«éo)';
                }, 500);
                
                // Recognize speech
                recognizer.recognizeOnceAsync(
                    (result) => {
                        testBtn.disabled = false;
                        testBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                        
                        if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                            statusDiv.className = 'status success';
                            statusDiv.innerHTML = '‚úÖ Speech recognized!';
                            
                            const pronResult = SpeechSDK.PronunciationAssessmentResult.fromResult(result);
                            
                            resultsDiv.innerHTML = `
                                <div class="info">
                                    <h3>üìä Assessment Results:</h3>
                                    <pre>
Recognized Text: ${result.text}
Expected Text: ${referenceText}

Scores:
- Accuracy: ${pronResult.accuracyScore.toFixed(1)}%
- Pronunciation: ${pronResult.pronunciationScore.toFixed(1)}%
- Completeness: ${pronResult.completenessScore.toFixed(1)}%
- Fluency: ${pronResult.fluencyScore.toFixed(1)}%

Overall: ${((pronResult.accuracyScore + pronResult.pronunciationScore + pronResult.completenessScore + pronResult.fluencyScore) / 4).toFixed(1)}%
                                    </pre>
                                </div>
                            `;
                            
                            updateSummary(true);
                        } else if (result.reason === SpeechSDK.ResultReason.NoMatch) {
                            statusDiv.className = 'status error';
                            statusDiv.innerHTML = '‚ùå No speech detected. Please try again and speak clearly.';
                            resultsDiv.innerHTML = '';
                        } else {
                            statusDiv.className = 'status error';
                            statusDiv.innerHTML = '‚ùå Recognition failed: ' + result.errorDetails;
                            resultsDiv.innerHTML = '<div class="error">Error details: ' + result.errorDetails + '</div>';
                        }
                        
                        recognizer.close();
                        recognizer = null;
                    },
                    (error) => {
                        testBtn.disabled = false;
                        statusDiv.className = 'status error';
                        statusDiv.innerHTML = '‚ùå Error: ' + error;
                        resultsDiv.innerHTML = '<div class="error"><strong>Error Details:</strong><br>' + error + '</div>';
                        
                        if (recognizer) {
                            recognizer.close();
                            recognizer = null;
                        }
                        
                        updateSummary(false, error);
                    }
                );
                
            } catch (error) {
                testBtn.disabled = false;
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå Exception: ' + error.message;
                resultsDiv.innerHTML = '<div class="error">' + error.message + '</div>';
                updateSummary(false, error.message);
            }
        };

        function updateSummary(success, error = null) {
            const summaryDiv = document.getElementById('summary');
            
            if (success) {
                summaryDiv.className = 'status success';
                summaryDiv.innerHTML = `
                    <h3>üéâ Azure Speech SDK is working correctly!</h3>
                    <p>Your pronunciation assessment is ready to use in the main application.</p>
                    <ul>
                        <li>‚úÖ Configuration is correct</li>
                        <li>‚úÖ SDK is loaded</li>
                        <li>‚úÖ Pronunciation assessment works</li>
                    </ul>
                `;
            } else if (error) {
                summaryDiv.className = 'status error';
                summaryDiv.innerHTML = `
                    <h3>‚ùå There's an issue with your setup</h3>
                    <p><strong>Error:</strong> ${error}</p>
                    <p><strong>Common solutions:</strong></p>
                    <ul>
                        <li>Double-check your subscription key in js/config.js</li>
                        <li>Verify your service region is correct (currently: ${azureSpeechConfig.serviceRegion})</li>
                        <li>Ensure your Azure subscription is active</li>
                        <li>Check that you haven't exceeded quota limits</li>
                        <li>Grant microphone permissions to this page</li>
                    </ul>
                `;
            }
        }

        // Run initial checks on page load
        window.addEventListener('DOMContentLoaded', () => {
            const configOk = checkConfiguration();
            const sdkOk = checkSDK();
            
            if (!configOk || !sdkOk) {
                document.getElementById('test-btn').disabled = true;
                updateSummary(false, 'Please fix configuration and SDK issues first');
            }
        });
    </script>
</body>
</html>
